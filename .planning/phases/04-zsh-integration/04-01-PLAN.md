---
phase: 04-zsh-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - zsh/cherry2k.plugin.zsh
  - zsh/widgets/ai-mode.zsh
  - crates/cli/src/output/retro.rs
  - crates/cli/src/output/mod.rs
autonomous: true

must_haves:
  truths:
    - "User can type `* ` and prompt changes to cherry emoji"
    - "User can backspace past `* ` to exit AI mode naturally"
    - "User can type message after `* ` prefix and see cherry prompt"
  artifacts:
    - path: "zsh/cherry2k.plugin.zsh"
      provides: "Main plugin entry point, sources widget files"
      min_lines: 20
    - path: "zsh/widgets/ai-mode.zsh"
      provides: "ZLE widget for prefix detection and AI mode state"
      min_lines: 50
      contains: "_cherry2k_self_insert"
    - path: "crates/cli/src/output/retro.rs"
      provides: "8-bit retro color scheme for terminal output"
      exports: ["retro_color_scheme", "apply_retro_skin"]
  key_links:
    - from: "zsh/cherry2k.plugin.zsh"
      to: "zsh/widgets/ai-mode.zsh"
      via: "source command"
      pattern: "source.*ai-mode.zsh"
    - from: "zsh/widgets/ai-mode.zsh"
      to: "ZLE self-insert"
      via: "widget registration"
      pattern: "zle -N self-insert"
---

<objective>
Implement the core ZLE widget infrastructure for `* ` prefix detection and AI mode state management.

Purpose: This is the foundation of the inline AI experience. Users type `* ` and immediately see the cherry emoji prompt, signaling they're in AI mode. The self-insert widget wrapper detects the prefix as the user types.

Output: Working zsh plugin with AI mode toggle, plus retro color scheme for future streaming output.
</objective>

<execution_context>
@/Users/dunnock/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dunnock/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-zsh-integration/04-CONTEXT.md
@.planning/phases/04-zsh-integration/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create main plugin file and widget infrastructure</name>
  <files>zsh/cherry2k.plugin.zsh, zsh/widgets/ai-mode.zsh</files>
  <action>
Create the main zsh plugin entry point and AI mode widget.

**zsh/cherry2k.plugin.zsh:**
- Source widgets/ai-mode.zsh
- Set plugin directory variable for relative sourcing
- Initialize plugin with `_cherry2k_plugin_init` call
- Guard against double-sourcing

**zsh/widgets/ai-mode.zsh:**
- Store original self-insert widget reference
- Create `_cherry2k_self_insert_wrapper` that:
  1. Calls original self-insert first
  2. Detects `* ` prefix when BUFFER == "* " (exactly two chars)
  3. Calls `_cherry2k_enter_ai_mode` on detection
  4. Detects backspace past prefix (BUFFER no longer starts with `* `) and exits AI mode
- Create `_cherry2k_enter_ai_mode`:
  1. Set `_CHERRY2K_AI_MODE=1`
  2. Save original PROMPT to `_CHERRY2K_SAVED_PROMPT`
  3. Strip `* ` from LBUFFER (keep internal tracking)
  4. Set PROMPT="üçí "
  5. Call `zle -R` to redisplay
- Create `_cherry2k_exit_ai_mode`:
  1. Set `_CHERRY2K_AI_MODE=0`
  2. Restore PROMPT from saved
  3. Call `zle -R`
- Create `_cherry2k_plugin_init`:
  1. Store original: `typeset -g _CHERRY2K_ORIGINAL_SELF_INSERT="${widgets[self-insert]}"`
  2. Init state: `typeset -g _CHERRY2K_AI_MODE=0`
  3. Register widget: `zle -N self-insert _cherry2k_self_insert_wrapper`
- Prefix all variables with `_CHERRY2K_` or `_cherry2k_` for namespace safety

Reference patterns from 04-RESEARCH.md Pattern 1 and Pattern 2.
  </action>
  <verify>
Source plugin in a new zsh session:
```bash
source zsh/cherry2k.plugin.zsh
# Type "* " at prompt
# Prompt should change to "üçí "
# Backspace twice, prompt should restore to original
```
  </verify>
  <done>
- Plugin sources without errors
- Typing `* ` changes prompt to cherry emoji
- Backspacing past prefix restores normal prompt
  </done>
</task>

<task type="auto">
  <name>Task 2: Add retro color scheme for terminal output</name>
  <files>crates/cli/src/output/retro.rs, crates/cli/src/output/mod.rs</files>
  <action>
Create retro 8-bit color scheme for AI responses, preparing for streaming output in Plan 02.

**crates/cli/src/output/retro.rs:**
- Create `RetroColors` struct with fields:
  - `text`: Bright green (AnsiValue 10) - classic terminal green for prose
  - `header`: Bright yellow (AnsiValue 11) - for markdown headers
  - `code`: Bright cyan (AnsiValue 14) - for code blocks
  - `code_bg`: Black (AnsiValue 0) - code block background
  - `prompt`: Bright magenta (AnsiValue 13) - for cherry prompt color
  - `error`: Bright red (AnsiValue 9) - for error messages
  - `dim`: Dark gray (AnsiValue 8) - for secondary text
- Create `retro_color_scheme() -> RetroColors` function
- Create `apply_retro_skin(skin: &mut MadSkin)` function that:
  - Sets paragraph foreground to retro green
  - Sets headers to bold yellow
  - Sets code_block to cyan on black
  - Sets inline_code to cyan
  - Sets bullet to green bullet character
- Import termimad types: `MadSkin`, `StyledChar`, and crossterm `Color`, `Attribute`
- Add `#[must_use]` to retro_color_scheme

**crates/cli/src/output/mod.rs:**
- Add `mod retro;`
- Export `pub use retro::{retro_color_scheme, apply_retro_skin, RetroColors};`

Reference 04-RESEARCH.md Example 5 for color scheme pattern.
  </action>
  <verify>
```bash
cargo check -p cherry2k-cli
cargo clippy -p cherry2k-cli -- -D warnings
```
  </verify>
  <done>
- Code compiles without warnings
- RetroColors struct and functions exported from output module
  </done>
</task>

</tasks>

<verification>
1. `source zsh/cherry2k.plugin.zsh` works in fresh zsh
2. `* ` prefix detection toggles AI mode visually (cherry prompt)
3. Backspace exit works naturally
4. `cargo check` passes for cli crate
5. No namespace pollution (all vars prefixed with _CHERRY2K_)
</verification>

<success_criteria>
- User can type `* ` and see cherry emoji prompt
- User can backspace to exit AI mode
- Retro color scheme ready for Plan 02 streaming
- Plugin can be sourced from .zshrc without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-zsh-integration/04-01-SUMMARY.md`
</output>
