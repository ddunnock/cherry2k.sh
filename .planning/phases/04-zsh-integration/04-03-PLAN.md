---
phase: 04-zsh-integration
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - zsh/widgets/keybindings.zsh
  - zsh/widgets/vim-navigation.zsh
  - zsh/completions/_cherry2k
  - zsh/cherry2k.plugin.zsh
autonomous: true

must_haves:
  truths:
    - "User can press Ctrl+G to enter AI mode from anywhere"
    - "Ctrl+G with empty prompt starts AI mode"
    - "Ctrl+G with text prepends `* ` to existing text"
    - "Tab completion works for cherry2k subcommands"
    - "Vim navigation works in AI mode input (if user has vim mode enabled)"
  artifacts:
    - path: "zsh/widgets/keybindings.zsh"
      provides: "Ctrl+G handler and mode-aware keybinding setup"
      contains: "_cherry2k_ctrl_g_handler"
    - path: "zsh/widgets/vim-navigation.zsh"
      provides: "Vim mode support for AI input"
      contains: "_cherry2k_setup_vim_bindings"
    - path: "zsh/completions/_cherry2k"
      provides: "Zsh completion definitions for cherry2k commands"
      contains: "#compdef cherry2k"
  key_links:
    - from: "zsh/cherry2k.plugin.zsh"
      to: "zsh/widgets/keybindings.zsh"
      via: "source command"
      pattern: "source.*keybindings.zsh"
    - from: "zsh/cherry2k.plugin.zsh"
      to: "zsh/completions/_cherry2k"
      via: "fpath setup"
      pattern: "fpath="
---

<objective>
Implement keybindings (Ctrl+G) and tab completions for cherry2k commands.

Purpose: Ctrl+G provides instant access to AI mode from anywhere on the command line. Tab completion makes the cherry2k CLI discoverable. Vim bindings support power users who use vi mode in their shell.

Output: Complete keybinding and completion infrastructure.
</objective>

<execution_context>
@/Users/dunnock/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dunnock/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-zsh-integration/04-CONTEXT.md
@.planning/phases/04-zsh-integration/04-RESEARCH.md
@.planning/phases/04-zsh-integration/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Ctrl+G keybinding</name>
  <files>zsh/widgets/keybindings.zsh, zsh/cherry2k.plugin.zsh</files>
  <action>
Create Ctrl+G handler for quick AI mode entry.

**zsh/widgets/keybindings.zsh:**
Create `_cherry2k_ctrl_g_handler` widget:
- If BUFFER is empty:
  - Set BUFFER="* "
  - Set CURSOR=2
  - Call `_cherry2k_enter_ai_mode`
- If BUFFER has text:
  - Prepend: BUFFER="* $BUFFER"
  - Adjust CURSOR: CURSOR=$((CURSOR + 2))
  - Call `_cherry2k_enter_ai_mode`
- Register: `zle -N _cherry2k_ctrl_g_handler`
- Bind for both keymaps (support emacs and vi users):
  - `bindkey '^G' _cherry2k_ctrl_g_handler` (main/emacs)
  - `bindkey -M viins '^G' _cherry2k_ctrl_g_handler` (vi insert)
  - `bindkey -M vicmd '^G' _cherry2k_ctrl_g_handler` (vi command)

**zsh/cherry2k.plugin.zsh:**
- Add `source "${_CHERRY2K_PLUGIN_DIR}/widgets/keybindings.zsh"` after ai-mode.zsh

Reference 04-RESEARCH.md Pattern 3 for keybinding pattern.
  </action>
  <verify>
```bash
source zsh/cherry2k.plugin.zsh
# With empty prompt, press Ctrl+G
# Prompt should show üçí and BUFFER should be "* "
# Type some text, press Ctrl+G again (after exiting first)
# With text "ls -la", Ctrl+G should give "* ls -la"
```
  </verify>
  <done>
- Ctrl+G enters AI mode from empty prompt
- Ctrl+G prepends `* ` to existing text
- Works in both emacs and vi keymaps
  </done>
</task>

<task type="auto">
  <name>Task 2: Add vim mode navigation support</name>
  <files>zsh/widgets/vim-navigation.zsh, zsh/cherry2k.plugin.zsh</files>
  <action>
Create vim navigation support for AI mode input.

**zsh/widgets/vim-navigation.zsh:**
Create `_cherry2k_setup_vim_bindings`:
- Only activate if user is in vim mode (check `bindkey -lL main | grep -q vi` or `[[ -o vi ]]`)
- If vim mode detected:
  - Bind Esc handler for AI mode: `bindkey -M viins '^[' _cherry2k_vim_escape`
  - Standard vim bindings already work (vi-beginning-of-line, etc.)
  - The escape handler should switch to vicmd but stay in AI mode

Create `_cherry2k_vim_escape` widget:
- If in AI mode (`_CHERRY2K_AI_MODE -eq 1`):
  - Switch to command mode: `zle -K vicmd`
  - Stay in AI mode (don't exit)
- Else:
  - Call standard `vi-cmd-mode`
- Register: `zle -N _cherry2k_vim_escape`

**zsh/cherry2k.plugin.zsh:**
- Add `source "${_CHERRY2K_PLUGIN_DIR}/widgets/vim-navigation.zsh"`
- Call `_cherry2k_setup_vim_bindings` in `_cherry2k_plugin_init`

Note: Vim bindings like ^, $, h, l, w, b already work natively in vi mode. We just need to handle Esc specially to not exit AI mode.
  </action>
  <verify>
```bash
# Enable vi mode first
bindkey -v
source zsh/cherry2k.plugin.zsh
# Enter AI mode, type some text
# Press Esc - should stay in AI mode but switch to command mode
# Press ^ - should go to beginning of line
# Press $ - should go to end
# Press i to return to insert mode
```
  </verify>
  <done>
- Vim escape works in AI mode (stays in AI mode, enters command mode)
- Standard vim navigation (^, $, h, l, w, b) works
- Works for users with `bindkey -v` enabled
  </done>
</task>

<task type="auto">
  <name>Task 3: Create tab completion for cherry2k</name>
  <files>zsh/completions/_cherry2k, zsh/cherry2k.plugin.zsh</files>
  <action>
Create zsh completion file for cherry2k CLI.

**zsh/completions/_cherry2k:**
```zsh
#compdef cherry2k

# Cherry2K completion definitions
# Generated from clap CLI structure

_cherry2k() {
    local -a commands
    commands=(
        'chat:Chat with AI (one-shot query)'
        'config:Show current configuration'
        'resume:Resume a previous session or list sessions'
        'new:Start a new session'
        'clear:Delete all sessions'
        'sentry-test:Test Sentry integration'
    )

    local -a global_opts
    global_opts=(
        '-l[Set log level]:level:(trace debug info warn error)'
        '--log-level[Set log level]:level:(trace debug info warn error)'
        '-h[Show help]'
        '--help[Show help]'
        '-V[Show version]'
        '--version[Show version]'
    )

    case "$words[1]" in
        chat)
            _arguments \
                '-p[Output plain text without markdown]' \
                '--plain[Output plain text without markdown]' \
                '--context-file[Path to JSON context file]:file:_files -g "*.json"' \
                '*:message:'
            ;;
        resume)
            _arguments \
                '-l[List all sessions]' \
                '--list[List all sessions]' \
                '*:session_id:'
            ;;
        sentry-test)
            _arguments \
                '--panic[Trigger a test panic]'
            ;;
        *)
            _describe 'command' commands
            ;;
    esac
}

_cherry2k "$@"
```

**zsh/cherry2k.plugin.zsh:**
- Add fpath setup at top of file (before any functions):
  ```zsh
  # Add completions to fpath
  fpath=("${_CHERRY2K_PLUGIN_DIR}/completions" $fpath)
  ```
- After all sources, call: `autoload -Uz compinit && compinit -i`
  - Use `-i` to ignore insecure directories (common with custom completions)
  - Or check if compinit already run: `(( $+functions[compinit] )) || { autoload -Uz compinit && compinit -i }`
  </action>
  <verify>
```bash
source zsh/cherry2k.plugin.zsh
cherry2k <TAB>
# Should show: chat config resume new clear sentry-test
cherry2k chat --<TAB>
# Should show: --plain --context-file --help
cherry2k resume --<TAB>
# Should show: --list
```
  </verify>
  <done>
- Tab completion shows cherry2k subcommands
- Subcommand options complete correctly
- File completion works for --context-file
  </done>
</task>

</tasks>

<verification>
1. Ctrl+G works from empty prompt (enters AI mode)
2. Ctrl+G works with existing text (prepends `* `)
3. Vim navigation works in AI mode for vi-mode users
4. `cherry2k <TAB>` shows subcommands
5. Subcommand options complete correctly
</verification>

<success_criteria>
- Ctrl+G keybinding triggers AI mode from anywhere
- Tab completion is discoverable and correct
- Vim users can navigate in AI mode naturally
- Plugin works in both emacs and vi keymaps
</success_criteria>

<output>
After completion, create `.planning/phases/04-zsh-integration/04-03-SUMMARY.md`
</output>
