---
phase: 03-storage-and-session-continuity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/storage/Cargo.toml
  - crates/storage/src/lib.rs
  - crates/storage/src/schema.rs
  - crates/storage/src/connection.rs
  - crates/core/src/error.rs
autonomous: true

must_haves:
  truths:
    - "SQLite database is created at XDG data directory path"
    - "Database schema exists with sessions and messages tables"
    - "Migrations run automatically on first connection"
    - "Database file has 0600 permissions (user read/write only)"
  artifacts:
    - path: "crates/storage/src/schema.rs"
      provides: "SQL schema definitions and migration runner"
      contains: "CREATE TABLE sessions"
    - path: "crates/storage/src/connection.rs"
      provides: "Async database connection wrapper"
      exports: ["Database"]
    - path: "crates/storage/src/lib.rs"
      provides: "Public storage API"
      exports: ["Database"]
  key_links:
    - from: "crates/storage/src/connection.rs"
      to: "crates/storage/src/schema.rs"
      via: "ensure_schema() call on open"
      pattern: "ensure_schema"
---

<objective>
Add SQLite dependencies, create database connection wrapper with tokio-rusqlite, and implement schema migrations.

Purpose: Establish the storage foundation for conversation persistence. This plan focuses solely on database infrastructure - no session or message logic yet.

Output: Working async SQLite connection with schema auto-migration, XDG-compliant database path, and proper file permissions.
</objective>

<execution_context>
@/Users/dunnock/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dunnock/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-storage-and-session-continuity/03-RESEARCH.md

# Relevant codebase files
@Cargo.toml
@crates/storage/Cargo.toml
@crates/storage/src/lib.rs
@crates/core/src/error.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SQLite dependencies to workspace</name>
  <files>Cargo.toml, crates/storage/Cargo.toml</files>
  <action>
Add tokio-rusqlite and rusqlite to workspace dependencies in root Cargo.toml:

```toml
rusqlite = { version = "0.33", features = ["bundled"] }
tokio-rusqlite = "0.6"
chrono = { version = "0.4", features = ["serde"] }
```

Note: Use rusqlite 0.33 and tokio-rusqlite 0.6 for compatibility (0.7 requires rusqlite 0.38 which has breaking API changes). The bundled feature compiles SQLite from source for consistent behavior.

Add chrono for timestamp handling with serde support.

Update crates/storage/Cargo.toml to include:
- rusqlite.workspace = true
- tokio-rusqlite.workspace = true
- directories.workspace = true
- chrono.workspace = true
- tokio.workspace = true (needed for async runtime in tests)
  </action>
  <verify>
```bash
cd /Users/dunnock/projects/cherry2k && cargo check -p cherry2k-storage
```
No errors about missing dependencies.
  </verify>
  <done>All SQLite and async dependencies compile successfully in the storage crate.</done>
</task>

<task type="auto">
  <name>Task 2: Create database schema and connection wrapper</name>
  <files>crates/storage/src/lib.rs, crates/storage/src/schema.rs, crates/storage/src/connection.rs, crates/core/src/error.rs</files>
  <action>
Create crates/storage/src/schema.rs with:
- SCHEMA_VERSION constant (1)
- INIT_SCHEMA SQL string defining:
  - schema_version table (tracks migrations)
  - sessions table (id TEXT PK, working_dir TEXT, created_at TEXT, last_message_at TEXT)
  - messages table (id INTEGER PK AUTOINCREMENT, session_id TEXT FK, role TEXT, content TEXT, token_count INTEGER nullable, is_summary BOOLEAN default 0, created_at TEXT)
  - Indexes: idx_sessions_dir_time, idx_messages_session
- ensure_schema(conn: &rusqlite::Connection) function that runs schema if version doesn't exist

Create crates/storage/src/connection.rs with:
- Database struct wrapping tokio_rusqlite::Connection
- Database::open() async function that:
  1. Gets XDG data directory via directories::ProjectDirs::from("", "", "cherry2k")
  2. Creates directory if needed (fs::create_dir_all)
  3. Opens connection to sessions.db
  4. Sets file permissions to 0600 on Unix
  5. Configures busy_timeout(5 seconds) and foreign_keys=ON
  6. Calls ensure_schema()
- Database::call() method wrapping tokio_rusqlite::Connection::call()

Update crates/core/src/error.rs to add:
- StorageError::IoError variant with #[from] std::io::Error
- StorageError::NoHomeDir variant for when XDG directories unavailable

Update crates/storage/src/lib.rs to:
- Declare modules: mod connection; mod schema;
- Re-export Database from connection
- Re-export StorageError from core

Follow patterns from research:
- Use conn.busy_timeout(Duration::from_secs(5)) for concurrency
- Use PRAGMA foreign_keys = ON for referential integrity
- Use datetime('now') for timestamps (SQLite native)
  </action>
  <verify>
```bash
cd /Users/dunnock/projects/cherry2k && cargo test -p cherry2k-storage
```
Tests pass. Manual verification:
```bash
cargo build -p cherry2k-storage
# Check that database would be created at correct XDG path
```
  </verify>
  <done>
- Database struct exists with async open() and call() methods
- Schema creates sessions and messages tables with proper indexes
- Database file uses 0600 permissions on Unix
- XDG data directory path used (~/.local/share/cherry2k/sessions.db on Linux, ~/Library/Application Support/cherry2k on macOS)
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/dunnock/projects/cherry2k
cargo check -p cherry2k-storage
cargo test -p cherry2k-storage
cargo clippy -p cherry2k-storage -- -D warnings
```

All commands should pass without errors or warnings.
</verification>

<success_criteria>
1. `cargo check -p cherry2k-storage` succeeds
2. `cargo test -p cherry2k-storage` passes (at least schema tests)
3. Database struct is public and documented
4. Schema SQL is valid and creates expected tables
5. Connection wrapper properly configures SQLite for robustness
</success_criteria>

<output>
After completion, create `.planning/phases/03-storage-and-session-continuity/03-01-SUMMARY.md`
</output>
