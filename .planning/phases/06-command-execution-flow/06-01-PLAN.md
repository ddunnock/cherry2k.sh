---
phase: 06-command-execution-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/cli/src/intent/mod.rs
  - crates/cli/src/intent/types.rs
  - crates/cli/src/intent/detector.rs
  - crates/cli/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "AI responses with bash code blocks are detected as command suggestions"
    - "Explicit markers (! prefix, /run prefix) force command mode"
    - "? suffix forces question mode"
    - "Ambiguous requests default to command mode"
  artifacts:
    - path: "crates/cli/src/intent/types.rs"
      provides: "Intent enum (Question, Command)"
      exports: ["Intent", "DetectedCommand"]
    - path: "crates/cli/src/intent/detector.rs"
      provides: "Intent detection from AI response parsing"
      exports: ["detect_intent", "parse_command_from_response"]
    - path: "crates/cli/src/intent/mod.rs"
      provides: "Module exports"
  key_links:
    - from: "detector.rs"
      to: "types.rs"
      via: "Intent enum usage"
      pattern: "Intent::"
---

<objective>
Create intent detection module that distinguishes AI responses containing command suggestions from explanatory answers.

Purpose: Enable the chat flow to detect when AI suggests a command (via bash code block) vs provides an explanation, triggering the appropriate follow-up action (command confirmation vs display).

Output: Intent detection module in crates/cli/src/intent/ with types and detection logic.
</objective>

<execution_context>
@/Users/dunnock/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dunnock/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-command-execution-flow/06-CONTEXT.md
@.planning/phases/06-command-execution-flow/06-RESEARCH.md
@crates/cli/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create intent types</name>
  <files>crates/cli/src/intent/types.rs</files>
  <action>
Create types for intent detection:

```rust
/// Detected intent from AI response
pub enum Intent {
    /// AI provided an explanatory answer (no command to run)
    Question,
    /// AI suggested a command to execute
    Command(DetectedCommand),
}

/// A command detected in AI response
pub struct DetectedCommand {
    /// The command string extracted from code block
    pub command: String,
    /// Any explanation text before the code block
    pub context: Option<String>,
}
```

Intent derives Debug, Clone. DetectedCommand derives Debug, Clone.

Include impl for DetectedCommand::new(command: impl Into<String>) for convenience.
  </action>
  <verify>cargo check -p cherry2k</verify>
  <done>Intent and DetectedCommand types exist and compile</done>
</task>

<task type="auto">
  <name>Task 2: Implement intent detector</name>
  <files>crates/cli/src/intent/detector.rs</files>
  <action>
Implement response parsing to detect commands:

1. `parse_command_from_response(response: &str) -> Option<DetectedCommand>`:
   - Use regex to find ```bash or ```sh code blocks
   - Extract command from first matching block
   - Capture text before the code block as context (if any, trimmed)
   - Pattern: r"```(?:bash|sh|shell)\n([\s\S]*?)\n```"
   - Return None if no code block found

2. `detect_intent(response: &str) -> Intent`:
   - Call parse_command_from_response
   - Return Intent::Command if found, Intent::Question otherwise

Add tests:
- Response with bash code block returns Intent::Command
- Response with sh code block returns Intent::Command
- Response with shell code block returns Intent::Command
- Response without code block returns Intent::Question
- Response with other code block (python, js) returns Intent::Question
- Multi-line commands are captured correctly
- Context before code block is captured
- Empty code block returns Intent::Question

Use `regex` crate (add to dependencies if not present).
  </action>
  <verify>cargo test -p cherry2k intent::detector</verify>
  <done>Intent detection parses bash code blocks correctly with passing tests</done>
</task>

<task type="auto">
  <name>Task 3: Wire intent module into CLI</name>
  <files>crates/cli/src/intent/mod.rs, crates/cli/src/lib.rs</files>
  <action>
Create mod.rs that exports:
```rust
mod types;
mod detector;

pub use types::{Intent, DetectedCommand};
pub use detector::{detect_intent, parse_command_from_response};
```

Update crates/cli/src/lib.rs to add:
```rust
pub mod intent;
```

Ensure the module is accessible as `cherry2k::intent::*`.
  </action>
  <verify>cargo check -p cherry2k && cargo test -p cherry2k intent</verify>
  <done>Intent module is exported and all tests pass</done>
</task>

</tasks>

<verification>
- `cargo check -p cherry2k` succeeds
- `cargo test -p cherry2k intent` runs tests for the new module
- `cargo clippy -p cherry2k -- -D warnings` passes
</verification>

<success_criteria>
- Intent enum distinguishes Question from Command responses
- parse_command_from_response extracts commands from bash/sh/shell code blocks
- Context text before code block is captured
- Non-bash code blocks (python, js, etc.) are NOT treated as commands
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-command-execution-flow/06-01-SUMMARY.md`
</output>
