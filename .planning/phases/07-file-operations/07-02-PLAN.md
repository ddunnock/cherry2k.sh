---
phase: 07-file-operations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/cli/src/files/diff.rs
  - crates/cli/src/files/writer.rs
  - crates/cli/src/files/mod.rs
  - Cargo.toml
  - crates/cli/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "User sees colored diff preview before file is written (red for deleted, green for added)"
    - "User sees formatted preview when AI proposes a new file"
    - "User can approve [y], reject [n], or edit [e] proposed file changes"
    - "User can edit proposed content in $EDITOR before final approval"
  artifacts:
    - path: "crates/cli/src/files/diff.rs"
      provides: "Unified diff generation with colored output"
      exports: ["generate_diff", "display_new_file_preview"]
    - path: "crates/cli/src/files/writer.rs"
      provides: "File write with approval flow"
      exports: ["write_file_with_approval", "WriteResult"]
  key_links:
    - from: "crates/cli/src/files/diff.rs"
      to: "similar crate"
      via: "TextDiff::from_lines"
      pattern: "TextDiff::from_lines"
    - from: "crates/cli/src/files/writer.rs"
      to: "crates/cli/src/confirm.rs"
      via: "confirm function"
      pattern: "confirm\\("
    - from: "crates/cli/src/files/writer.rs"
      to: "edit crate"
      via: "$EDITOR integration"
      pattern: "edit::edit"
---

<objective>
Implement unified diff preview and file write approval flow.

Purpose: Enable AI to propose file changes with clear diff visualization, and give users control to approve, edit, or reject changes before they're written.

Output: Diff generation and file write modules with [y/n/e] approval flow consistent with command confirmation.
</objective>

<execution_context>
@/Users/dunnock/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dunnock/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-file-operations/07-RESEARCH.md

# Key reference files
@crates/cli/src/confirm.rs
@crates/cli/src/files/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add similar crate dependency and create diff module</name>
  <files>
    Cargo.toml
    crates/cli/Cargo.toml
    crates/cli/src/files/diff.rs
    crates/cli/src/files/mod.rs
  </files>
  <action>
1. Add to workspace Cargo.toml [workspace.dependencies]:
   - similar = "2.7"

2. Add to crates/cli/Cargo.toml dependencies:
   - similar.workspace = true

3. Create crates/cli/src/files/diff.rs:

   Use similar::TextDiff for unified diff generation.

   `generate_diff(old: &str, new: &str, filename: &str) -> String`:
   - Create TextDiff::from_lines(old, new)
   - Format as unified diff with header:
     ```
     --- a/{filename}
     +++ b/{filename}
     ```
   - Use unified_diff().context_radius(3) for 3 lines of context
   - Iterate hunks, add hunk headers (@@ -X,Y +X,Y @@)
   - Color lines: '-' -> red, '+' -> green, ' ' -> normal (use colored crate)
   - Return formatted string

   `display_new_file_preview(content: &str, filename: &str)`:
   - Print "New file: {filename}" in green
   - Print separator line
   - Print content with line numbers
   - Print closing separator

   `has_changes(old: &str, new: &str) -> bool`:
   - Quick check if diff would be empty

4. Update crates/cli/src/files/mod.rs:
   - Add `pub mod diff;`
   - Re-export: `generate_diff`, `display_new_file_preview`

5. Tests:
   - generate_diff produces unified format
   - Added lines show as green +
   - Removed lines show as red -
   - Context lines have no color
   - Empty diff case handled
   - New file preview formats correctly
  </action>
  <verify>
    cargo test --package cherry2k -- files::diff
  </verify>
  <done>
    Diff module generates colored unified diffs, tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement file writer with approval flow</name>
  <files>
    crates/cli/src/files/writer.rs
    crates/cli/src/files/mod.rs
  </files>
  <action>
Create writer.rs with approval-gated file writing:

1. `WriteResult` enum:
   - Written { path } - file was written
   - Cancelled - user said no
   - Skipped - no changes needed

2. `write_file_with_approval(path: &Path, new_content: &str, auto_write: bool) -> Result<WriteResult>`:
   - Read existing content (empty string if new file)
   - If no changes (old == new), return Skipped
   - Display diff or new file preview:
     - Existing file: print generate_diff()
     - New file: print display_new_file_preview()
   - If auto_write is true, skip confirmation and write
   - Otherwise, enter approval loop:

   Approval loop (matches command confirmation pattern):
   ```rust
   loop {
       match confirm("Write this file?", true)? {
           ConfirmResult::Yes => {
               fs::write(path, &content)?;
               return Ok(WriteResult::Written { path });
           }
           ConfirmResult::No => return Ok(WriteResult::Cancelled),
           ConfirmResult::Edit => {
               // Open in $EDITOR
               content = edit::edit(&content)?;
               // Re-display diff and continue loop
               ...
           }
       }
   }
   ```

3. `write_multiple_files(files: &[(PathBuf, String)], auto_write: bool) -> Result<Vec<WriteResult>>`:
   - For multiple file changes, show all diffs first
   - Then offer: "Write all files? [y/n/step]"
   - 'step' processes files one at a time with individual approval
   - Return vector of results

4. Update crates/cli/src/files/mod.rs:
   - Add `pub mod writer;`
   - Re-export: `write_file_with_approval`, `WriteResult`

5. Tests (use tempfile):
   - New file creation with approval -> Written
   - Edit existing file with approval -> Written
   - Cancel write -> Cancelled
   - No changes -> Skipped
   - Edit option modifies content and re-prompts
  </action>
  <verify>
    cargo test --package cherry2k -- files::writer
  </verify>
  <done>
    File writer implements [y/n/e] approval flow, tests pass
  </done>
</task>

</tasks>

<verification>
```bash
# All file module tests pass
cargo test --package cherry2k -- files::

# Compiles cleanly
cargo check --package cherry2k

# No warnings
cargo clippy --package cherry2k -- -D warnings
```
</verification>

<success_criteria>
1. `generate_diff()` produces git-style unified diffs with colored output
2. `display_new_file_preview()` shows new file content clearly
3. `write_file_with_approval()` gates writes behind [y/n/e] confirmation
4. Edit option opens $EDITOR and loops back for re-confirmation
5. Auto-write mode bypasses confirmation when configured
6. All tests pass with `cargo test`
</success_criteria>

<output>
After completion, create `.planning/phases/07-file-operations/07-02-SUMMARY.md`
</output>
