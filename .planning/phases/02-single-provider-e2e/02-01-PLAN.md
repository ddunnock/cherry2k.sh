---
phase: 02-single-provider-e2e
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/core/Cargo.toml
  - crates/core/src/lib.rs
  - crates/core/src/provider/mod.rs
  - crates/core/src/provider/trait.rs
  - crates/core/src/provider/types.rs
  - crates/core/src/error.rs
autonomous: true

must_haves:
  truths:
    - "AiProvider trait is defined with complete(), provider_id(), validate_config(), health_check() methods"
    - "CompletionRequest and CompletionStream types are defined"
    - "Trait uses native async (Rust 1.75+), no async-trait crate"
  artifacts:
    - path: "crates/core/src/provider/trait.rs"
      provides: "AiProvider trait definition with streaming completion"
      exports: ["AiProvider", "CompletionStream"]
    - path: "crates/core/src/provider/types.rs"
      provides: "Request/response types for AI completions"
      exports: ["CompletionRequest", "Message", "Role"]
    - path: "crates/core/src/provider/mod.rs"
      provides: "Provider module re-exports"
  key_links:
    - from: "crates/core/src/provider/trait.rs"
      to: "crates/core/src/error.rs"
      via: "ProviderError and ConfigError imports"
      pattern: "use crate::error::"
---

<objective>
Define the provider trait abstraction and completion types that all AI providers will implement.

Purpose: Establish the foundation for Phase 2 OpenAI implementation and future multi-provider support (Phase 5). The trait design follows CONTEXT.md decisions: streaming-only method, explicit validate_config(), extension traits for provider-specific features.

Output: Provider trait and types that can be imported by OpenAI implementation (Plan 02-03).
</objective>

<execution_context>
@/Users/dunnock/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dunnock/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-single-provider-e2e/02-CONTEXT.md
@.planning/phases/02-single-provider-e2e/02-RESEARCH.md
@.planning/phases/01-foundation-and-safety/01-01-SUMMARY.md

Key constraints from CONTEXT.md:
- Streaming-only method (single complete() returning stream)
- Extension trait pattern for provider-specific features
- Explicit validate_config() method (constructor succeeds, caller validates)
- Include health_check() method (async ping for reachability)

From RESEARCH.md:
- Use native async traits (Rust 1.75+, no async-trait crate)
- CompletionStream = Pin<Box<dyn Stream<Item = Result<String, ProviderError>> + Send>>
- Use futures::Stream trait
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add streaming dependencies to workspace</name>
  <files>Cargo.toml, crates/core/Cargo.toml</files>
  <action>
Add these dependencies to the workspace Cargo.toml [workspace.dependencies]:
- reqwest = { version = "0.12", features = ["json", "stream"] }
- futures = "0.3"
- tokio-stream = "0.1"
- async-stream = "0.3"

Add to crates/core/Cargo.toml dependencies:
- reqwest.workspace = true
- futures.workspace = true
- tokio-stream.workspace = true
- async-stream.workspace = true

Note: reqwest-eventsource will be added in Plan 02-03 when implementing OpenAI streaming.
  </action>
  <verify>cargo check -p cherry2k-core compiles without errors</verify>
  <done>Streaming dependencies available in core crate</done>
</task>

<task type="auto">
  <name>Task 2: Create provider types and trait</name>
  <files>
    crates/core/src/provider/mod.rs
    crates/core/src/provider/trait.rs
    crates/core/src/provider/types.rs
    crates/core/src/lib.rs
  </files>
  <action>
Create crates/core/src/provider/mod.rs:
- Re-export AiProvider, CompletionStream from trait.rs
- Re-export CompletionRequest, Message, Role from types.rs

Create crates/core/src/provider/types.rs:
- Role enum (System, User, Assistant) with serde Serialize/Deserialize
- Message struct { role: Role, content: String } with serde
- CompletionRequest struct { messages: Vec<Message>, model: Option<String>, temperature: Option<f32>, max_tokens: Option<u32> } with builder pattern
- Implement Default for CompletionRequest

Create crates/core/src/provider/trait.rs:
- Import futures::Stream, std::pin::Pin
- Import crate::error::{ProviderError, ConfigError}
- Define type alias: pub type CompletionStream = Pin<Box<dyn Stream<Item = Result<String, ProviderError>> + Send>>;
- Define AiProvider trait (not using async-trait crate):
  ```rust
  pub trait AiProvider: Send + Sync {
      /// Stream completion chunks. Non-streaming callers collect the stream.
      fn complete(&self, request: CompletionRequest) -> impl Future<Output = Result<CompletionStream, ProviderError>> + Send;

      /// Provider identifier for logging/config
      fn provider_id(&self) -> &'static str;

      /// Validate config (constructor succeeds, caller decides when to validate)
      fn validate_config(&self) -> Result<(), ConfigError>;

      /// Health check - async ping to confirm reachable
      fn health_check(&self) -> impl Future<Output = Result<(), ProviderError>> + Send;
  }
  ```

Update crates/core/src/lib.rs:
- Add `pub mod provider;`
- Add re-exports for AiProvider, CompletionStream, CompletionRequest, Message, Role

Doc comments on all public types following project conventions.
  </action>
  <verify>
- cargo check -p cherry2k-core compiles
- cargo clippy -p cherry2k-core -- -D warnings passes
- cargo test -p cherry2k-core passes
  </verify>
  <done>Provider trait and types are defined and exported from cherry2k-core</done>
</task>

</tasks>

<verification>
Run these commands to verify the plan is complete:

```bash
# All code compiles
cargo check --workspace

# Clippy passes
cargo clippy --workspace -- -D warnings

# Tests pass
cargo test --workspace

# Verify trait is exported
grep -r "AiProvider" crates/core/src/lib.rs
grep -r "CompletionStream" crates/core/src/lib.rs
```
</verification>

<success_criteria>
1. cargo check --workspace passes with no errors
2. Provider trait is defined with complete(), provider_id(), validate_config(), health_check()
3. CompletionStream type alias defined using futures::Stream
4. All types exported from cherry2k_core::provider
5. No async-trait crate dependency (using native async traits)
</success_criteria>

<output>
After completion, create `.planning/phases/02-single-provider-e2e/02-01-SUMMARY.md`
</output>
