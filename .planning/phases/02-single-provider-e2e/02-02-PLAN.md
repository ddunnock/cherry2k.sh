---
phase: 02-single-provider-e2e
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/cli/Cargo.toml
  - crates/cli/src/output/mod.rs
  - crates/cli/src/output/spinner.rs
  - crates/cli/src/output/error_box.rs
  - crates/cli/src/output/markdown.rs
  - crates/cli/src/output/stream_writer.rs
autonomous: true

must_haves:
  truths:
    - "Spinner shows animated waiting state before response arrives"
    - "Errors display in boxed/framed visual block with actionable guidance"
    - "Markdown can be rendered or bypassed with --plain flag"
    - "Stream output is line-buffered (not character-by-character)"
  artifacts:
    - path: "crates/cli/src/output/spinner.rs"
      provides: "Spinner wrapper using indicatif"
      exports: ["ResponseSpinner"]
    - path: "crates/cli/src/output/error_box.rs"
      provides: "Boxed error display with cli-boxes"
      exports: ["display_error"]
    - path: "crates/cli/src/output/markdown.rs"
      provides: "Terminal markdown rendering via termimad"
      exports: ["render_markdown"]
    - path: "crates/cli/src/output/stream_writer.rs"
      provides: "Line-buffered output for streaming"
      exports: ["StreamWriter"]
  key_links:
    - from: "crates/cli/src/output/error_box.rs"
      to: "cherry2k_core::ProviderError"
      via: "Error type matching for custom messages"
      pattern: "ProviderError::(RateLimited|InvalidApiKey)"
---

<objective>
Create terminal output utilities: spinner for waiting, error boxes for clear error display, markdown rendering, and line-buffered stream output.

Purpose: These utilities will be used by the chat command (Plan 02-03) to display AI responses with proper formatting. The design follows CONTEXT.md decisions: line-buffered output, animated spinner, boxed error frames.

Output: Output module with spinner, error_box, markdown, and stream_writer.
</objective>

<execution_context>
@/Users/dunnock/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dunnock/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-single-provider-e2e/02-CONTEXT.md
@.planning/phases/02-single-provider-e2e/02-RESEARCH.md

Key constraints from CONTEXT.md:
- Line-buffered output (buffer until newline, then print whole line)
- Animated spinner/dots while waiting for first content
- Errors in boxed/framed visual block
- Rate limit errors show quota info and retry suggestion
- Invalid API key errors provide config guidance
- Markdown rendering with --plain toggle
- Subtle icon prefix before response

From RESEARCH.md:
- indicatif 0.18 for spinners
- cli-boxes for error frames
- colored for ANSI colors
- termimad for markdown rendering
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add output dependencies to workspace</name>
  <files>Cargo.toml, crates/cli/Cargo.toml</files>
  <action>
Add these dependencies to the workspace Cargo.toml [workspace.dependencies]:
- indicatif = "0.17"
- termimad = "0.30"
- colored = "3"

Note: cli-boxes is not available on crates.io. Instead, use Unicode box-drawing characters directly.

Add to crates/cli/Cargo.toml dependencies:
- indicatif.workspace = true
- termimad.workspace = true
- colored.workspace = true
- cherry2k-core (already present, needed for error types)
  </action>
  <verify>cargo check -p cherry2k compiles without errors</verify>
  <done>Output dependencies available in CLI crate</done>
</task>

<task type="auto">
  <name>Task 2: Create output module with spinner and stream writer</name>
  <files>
    crates/cli/src/output/mod.rs
    crates/cli/src/output/spinner.rs
    crates/cli/src/output/stream_writer.rs
  </files>
  <action>
Create crates/cli/src/output/mod.rs:
- Re-export ResponseSpinner from spinner.rs
- Re-export StreamWriter from stream_writer.rs
- Re-export display_error from error_box.rs
- Re-export render_markdown from markdown.rs

Create crates/cli/src/output/spinner.rs:
- Import indicatif::ProgressBar
- Define ResponseSpinner struct wrapping ProgressBar
- Implement new() -> Self: creates spinner with message "Waiting for response..."
- Implement start(&self): enables steady tick at 100ms
- Implement stop(&self): finish_and_clear()
- Use a simple dots animation (indicatif::ProgressStyle::default_spinner())
- Add doc comments

Create crates/cli/src/output/stream_writer.rs:
- Define StreamWriter struct with buffer: String and stdout: io::Stdout
- Implement new() -> Self
- Implement write_chunk(&mut self, chunk: &str) -> io::Result<()>:
  - Append chunk to buffer
  - While buffer contains '\n', print and drain up to newline
  - Flush stdout after each line
- Implement flush(&mut self) -> io::Result<()>:
  - Print remaining buffer content
  - Clear buffer
  - Flush stdout
- Add doc comments explaining line-buffered behavior
  </action>
  <verify>cargo check -p cherry2k compiles</verify>
  <done>Spinner and stream writer utilities created</done>
</task>

<task type="auto">
  <name>Task 3: Create error box and markdown rendering</name>
  <files>
    crates/cli/src/output/error_box.rs
    crates/cli/src/output/markdown.rs
    crates/cli/src/main.rs
  </files>
  <action>
Create crates/cli/src/output/error_box.rs:
- Import colored::Colorize
- Import cherry2k_core::ProviderError
- Define const BOX_TOP_LEFT, BOX_TOP_RIGHT, etc. using Unicode box-drawing chars (DOUBLE style: ╔ ╗ ╚ ╝ ═ ║)
- Implement display_error(error: &dyn std::error::Error):
  - Get terminal width or default to 60
  - Print top border with red color
  - For each line in formatted message, print with side borders
  - Print bottom border with red color
- Implement format_error_message(error: &dyn std::error::Error) -> String:
  - Match on ProviderError::RateLimited: show provider, retry_after_secs, retry suggestion
  - Match on ProviderError::InvalidApiKey: show provider, config guidance ("Set {PROVIDER}_API_KEY or check ~/.config/cherry2k/config.toml")
  - Default: error.to_string()
- Add doc comments

Create crates/cli/src/output/markdown.rs:
- Import termimad::MadSkin
- Implement render_markdown(text: &str, plain: bool) -> String:
  - If plain, return text as-is
  - Create MadSkin::default()
  - Customize: bold = Yellow, italic = Cyan, inline_code = Green
  - Return skin.term_text(text).to_string()
- Add doc comments

Update crates/cli/src/main.rs:
- Add `pub mod output;` to make output module available
  </action>
  <verify>
- cargo check -p cherry2k compiles
- cargo clippy -p cherry2k -- -D warnings passes
  </verify>
  <done>Error box and markdown rendering utilities created</done>
</task>

</tasks>

<verification>
Run these commands to verify the plan is complete:

```bash
# All code compiles
cargo check --workspace

# Clippy passes
cargo clippy --workspace -- -D warnings

# Tests pass
cargo test --workspace

# Verify exports
grep -r "ResponseSpinner" crates/cli/src/output/mod.rs
grep -r "StreamWriter" crates/cli/src/output/mod.rs
grep -r "display_error" crates/cli/src/output/mod.rs
grep -r "render_markdown" crates/cli/src/output/mod.rs
```
</verification>

<success_criteria>
1. cargo check --workspace passes with no errors
2. ResponseSpinner wraps indicatif for waiting animation
3. StreamWriter implements line-buffered output with write_chunk/flush
4. display_error shows boxed error with custom messages for RateLimited/InvalidApiKey
5. render_markdown supports plain mode toggle
6. All output utilities exported from crates/cli/src/output/mod.rs
</success_criteria>

<output>
After completion, create `.planning/phases/02-single-provider-e2e/02-02-SUMMARY.md`
</output>
